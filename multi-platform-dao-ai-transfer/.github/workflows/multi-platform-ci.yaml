name: Multi-Platform CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: "18"
  PYTHON_VERSION: "3.11"
  DOCKER_REGISTRY: docker.io/aisolutions

jobs:
  # Job 1: Validate Smart Contracts
  validate-contracts:
    name: Validate DAO Smart Contracts
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: platforms/dao-platform
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: platforms/dao-platform/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts
        run: npx hardhat compile

      - name: Run Slither analysis
        uses: crytic/slither-action@v0.3.0
        with:
          target: 'platforms/dao-platform/contracts/'
          slither-args: '--filter-paths "node_modules"'

      - name: Generate gas report
        run: npx hardhat test --network hardhat

  # Job 2: Build DAO Platform
  build-dao:
    name: Build DAO Platform
    runs-on: ubuntu-latest
    needs: validate-contracts
    defaults:
      run:
        working-directory: platforms/dao-platform/frontend
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Run tests
        run: npm test --if-present

  # Job 3: Build ClaudeDroid AI
  build-ai:
    name: Build ClaudeDroid AI Platform
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: platforms/claudedroid-ai
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Lint with ruff
        run: |
          pip install ruff
          ruff check src/

      - name: Type check with mypy
        run: |
          pip install mypy
          mypy src/ --ignore-missing-imports

      - name: Run tests
        run: |
          pip install pytest pytest-asyncio pytest-cov
          pytest src/ --cov --cov-report=xml

  # Job 4: Build Marketplace
  build-marketplace:
    name: Build Marketplace
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: platforms/marketplace
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run tests
        run: npm test --if-present

  # Job 5: Build Dashboard
  build-dashboard:
    name: Build Unified Dashboard
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: platforms/dashboard
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Type check
        run: npm run type-check

  # Job 6: Docker Build All Platforms
  docker-build:
    name: Docker Build - ${{ matrix.platform }}
    runs-on: ubuntu-latest
    needs: [build-dao, build-ai, build-marketplace, build-dashboard]
    strategy:
      matrix:
        platform:
          - dao-platform
          - claudedroid-ai
          - marketplace
          - dashboard
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.platform }}
        uses: docker/build-push-action@v5
        with:
          context: ./platforms/${{ matrix.platform }}
          push: false
          tags: ${{ env.DOCKER_REGISTRY }}/${{ matrix.platform }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_REGISTRY }}/${{ matrix.platform }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results-${{ matrix.platform }}.sarif'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results-${{ matrix.platform }}.sarif'

  # Job 7: Test AI Models
  test-ai-models:
    name: Test AI Model Loading
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Test LocalAI connection
        run: |
          docker run -d --name localai -p 8080:8080 localai/localai:v2.9.0
          sleep 10
          curl -f http://localhost:8080/v1/models || exit 1

      - name: Test Ollama connection
        run: |
          docker run -d --name ollama -p 11434:11434 ollama/ollama:latest
          sleep 10
          curl -f http://localhost:11434/api/tags || exit 1

  # Job 8: Validate Helm Charts
  helm-validate:
    name: Validate Helm Charts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'

      - name: Lint Helm chart
        run: helm lint infra/helm/multi-platform

      - name: Template chart with dev values
        run: |
          helm template test infra/helm/multi-platform \
            --values infra/helm/multi-platform/values.yaml \
            > /tmp/manifests.yaml

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'

      - name: Validate K8s manifests
        run: kubectl apply --dry-run=client -f /tmp/manifests.yaml

  # Job 9: Validate K8s Manifests
  k8s-validate:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Validate namespace
        run: kubectl apply --dry-run=client -f infra/k8s/namespace.yaml

      - name: Validate ingress
        run: kubectl apply --dry-run=client -f infra/k8s/ingress-multi-domain.yaml

      - name: Validate secrets
        run: kubectl apply --dry-run=client -f infra/k8s/secrets.yaml

  # Job 10: Security Audit
  security-audit:
    name: Security & Compliance Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for hardcoded secrets
        run: |
          ! grep -r "sk-ant-" platforms/ --include="*.ts" --include="*.py" --include="*.js" || exit 1
          ! grep -r "AKIA" infra/ --include="*.yaml" || exit 1
          ! grep -r "0x[0-9a-fA-F]\{64\}" platforms/ --include="*.ts" || exit 1

      - name: NPM audit (DAO)
        run: cd platforms/dao-platform && npm audit --production

      - name: NPM audit (Marketplace)
        run: cd platforms/marketplace && npm audit --production

      - name: NPM audit (Dashboard)
        run: cd platforms/dashboard && npm audit --production

      - name: Python safety check
        run: |
          cd platforms/claudedroid-ai
          pip install safety
          safety check -r requirements.txt

  # Job 11: Deploy to Testnet (Sepolia)
  deploy-testnet:
    name: Deploy DAO to Sepolia
    runs-on: ubuntu-latest
    needs: [validate-contracts, docker-build, helm-validate, security-audit]
    if: github.ref == 'refs/heads/develop'
    defaults:
      run:
        working-directory: platforms/dao-platform
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Deploy contracts to Sepolia
        run: npx hardhat run scripts/deploy-dao.ts --network sepolia
        env:
          SEPOLIA_RPC_URL: ${{ secrets.SEPOLIA_RPC_URL }}
          PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}

      - name: Save deployment addresses
        run: |
          echo "Deployment complete"
          # Save addresses to artifacts

  # Job 12: Deploy to Staging K8s
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [docker-build, helm-validate, k8s-validate]
    if: github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Deploy with Helm
        run: |
          helm upgrade --install multi-platform ./infra/helm/multi-platform \
            --namespace ai-solutions \
            --create-namespace \
            --values infra/helm/multi-platform/values-staging.yaml \
            --wait --timeout 10m

  # Job 13: Production Ready Gate
  production-ready:
    name: Mark Production Ready
    runs-on: ubuntu-latest
    needs: [deploy-testnet, deploy-staging]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Production deployment ready
        run: echo "✅ All validations passed - ready for production deployment"

      - name: Create release tag
        run: |
          echo "Ready to create release tag v${{ github.run_number }}"

      - name: Comment on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ **Production Ready** - All CI checks passed. Safe to merge and deploy.'
            })
